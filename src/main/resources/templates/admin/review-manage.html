<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8"/>
    <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
    <title>Quản lý đánh giá - Admin Panel</title>
    <link
            href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css"
            rel="stylesheet"
    />
    <link
            href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
            rel="stylesheet"
    />
    <link rel="stylesheet" th:href="@{/css/admin.css}"/>
    <style>
        .star-rating {
            color: #ffc107;
        }

        .review-status {
            padding: 0.5em 1em;
            border-radius: 20px;
            font-weight: 500;
        }

        .status-pending {
            background-color: #ffeeba;
            color: #856404;
        }

        .status-approved {
            background-color: #d4edda;
            color: #155724;
        }

        .status-rejected {
            background-color: #f5c6cb;
            color: #721c24;
        }
        .btn-group {
            display: flex;
            gap: 0.5rem;
        }
    </style>
</head>
<body>
<div class="admin-layout">
    <!-- Sidebar -->
    <div th:replace="admin/fragments/admin-sidebar :: sidebar"></div>

    <!-- Main Content -->
    <div class="admin-main-content">
        <div
                class="content-header d-flex justify-content-between align-items-center"
        >
            <h1>Quản lý đánh giá</h1>
            <div class="header-actions">
                <button
                        class="btn btn-primary"
                        data-bs-target="#filterModal"
                        data-bs-toggle="modal"
                >
                    <i class="fas fa-filter"></i> Lọc
                </button>
            </div>
        </div>

        <!-- Review Table -->
        <div class="card">
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                        <tr>
                            <th>ID</th>
                            <th>Sản phẩm</th>
                            <th>Khách hàng</th>
                            <th>Đánh giá</th>
                            <th>Nội dung</th>
                            <th>Ngày đánh giá</th>
                            <th>Trạng thái</th>
                            <th>Hành động</th>
                        </tr>
                        </thead>
                        <tbody>
                        <tr th:each="review : ${reviews}">
                            <td th:text="${review.getId()}">ID</td>
                            <td>
                                <a
                                        class="text-decoration-none"
                                        th:href="@{/products/{id}(id=${review.getProduct().getId()})}"
                                        th:text="${review.getProduct().getName()}"
                                >
                                    Sản phẩm
                                </a>
                            </td>
                            <td th:text="${review.getUser().getName()}">Khách hàng</td>
                            <td>
                                <div class="star-rating">
                                    <span th:each="star : ${#numbers.sequence(1, review.getRating())}">
                                        <i class="fas fa-star text-warning"></i>
                                    </span>
                                    <span th:if="${review.getRating()<5}" th:each="star : ${#numbers.sequence(review.getRating() + 1, 5)}">
                                        <i class="fas fa-star text-secondary"></i>
                                    </span>
                                </div>
                            </td>
                            <td th:text="${review.getComment()}">Nội dung</td>
                            <td
                                    th:text="${#temporals.format(review.getCreatedAt(), 'dd/MM/yyyy HH:mm')}"
                            >
                                Ngày đánh giá
                            </td>
                            <td>
                      <span
                              th:class="'review-status status-' + ${#strings.toLowerCase(review.getReviewStatus().toString())}"
                              th:text="${review.getReviewStatus().toString()}"
                      >Status</span
                      >
                            </td>
                            <td>
                                <div class="btn-group">
                                    <button
                                            class="btn btn-sm btn-success"
                                            th:if="${review.getReviewStatus().toString().equals('PENDING')}"
                                            th:onclick="'approveReview(' + ${review.id} + ')'"
                                    >
                                        <i class="fas fa-check"></i>
                                    </button>
                                    <button
                                            class="btn btn-sm btn-warning"
                                            th:if="${review.getReviewStatus().toString().equals('PENDING')}"
                                            th:onclick="'rejectReview(' + ${review.id} + ')'"
                                    >
                                        <i class="fas fa-times"></i>
                                    </button>
                                    <button
                                            class="btn btn-sm btn-danger"
                                            th:onclick="'deleteReview(' + ${review.id} + ')'"
                                    >
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </td>
                        </tr>
                        </tbody>
                    </table>
                </div>

            </div>
        </div>
    </div>
</div>

<!-- Filter Modal -->
<div class="modal fade" id="filterModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Lọc đánh giá</h5>
                <button
                        class="btn-close"
                        data-bs-dismiss="modal"
                        type="button"
                ></button>
            </div>
            <div class="modal-body">
                <form method="get" th:action="@{/admin/reviews/list}">
                    <div class="mb-3">
                        <label class="form-label">Trạng thái</label>
                        <select class="form-select" name="status">
                            <option value="">Tất cả</option>
                            <option value="PENDING">Chờ duyệt</option>
                            <option value="APPROVED">Đã duyệt</option>
                            <option value="REJECTED">Đã từ chối</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Đánh giá tối thiểu</label>
                        <select class="form-select" name="minRating">
                            <option value="0">Tất cả</option>
                            <option value="5">5 sao</option>
                            <option value="4">4 sao trở lên</option>
                            <option value="3">3 sao trở lên</option>
                            <option value="2">2 sao trở lên</option>
                            <option value="1">1 sao trở lên</option>
                        </select>
                    </div>
                    <button class="btn btn-primary w-100" type="submit">
                        Áp dụng
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Scripts -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
    // Approve review
    function approveReview(reviewId) {
        if (confirm("Bạn có chắc chắn muốn duyệt đánh giá này?")) {
            updateReviewStatus(reviewId, "APPROVED");
        }
    }

    // Reject review
    function rejectReview(reviewId) {
        if (confirm("Bạn có chắc chắn muốn từ chối đánh giá này?")) {
            updateReviewStatus(reviewId, "REJECTED");
        }
    }

    // Update review status
    function updateReviewStatus(reviewId, status) {
        fetch(`/admin/reviews/update?reviewId=${reviewId}&status=${status}`, {
            method: "PUT",
            headers: {
                "Content-Type": "application/json",
            }
        }).then((response) => {
            if (response.ok) {
                location.reload();
            }
        });
    }

    // Delete review confirmation
    function deleteReview(reviewId) {
        if (confirm("Bạn có chắc muốn xóa đánh giá này?")) {
            fetch(`/admin/reviews/delete/${reviewId}`, {method: "DELETE"}).then(
                (response) => {
                    if (response.ok) {
                        location.reload();
                    }
                }
            );
        }
    }

    // Sidebar toggle functionality
    function toggleSidebar() {
        const sidebar = document.getElementById("sidebar");
        sidebar.classList.toggle("collapsed");
    }

    // Mobile responsive handling
    if (window.innerWidth <= 768) {
        document.querySelector(".sidebar").classList.add("collapsed");
    }
</script>
</body>
</html>
