<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="vi">
<head>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Quản Lý Đơn Hàng - Admin Panel</title>
    <link
            href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css"
            rel="stylesheet"
    />
    <link
            href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
            rel="stylesheet"
    />
    <link rel="stylesheet" th:href="@{/css/admin.css}"/>
    <style>
        .status-badge {
            padding: 0.5em 1em;
            border-radius: 20px;
            font-weight: 500;
        }

        .status-Pending {
            background-color: #ffeeba;
            color: #856404;
        }

        .status-Processing {
            background-color: #b8daff;
            color: #004085;
        }

        .status-Shipped {
            background-color: #c3e6cb;
            color: #155724;
        }

        .status-Completed {
            background-color: #d4edda;
            color: #155724;
        }

        .status-Cancelled {
            background-color: #f5c6cb;
            color: #721c24;
        }
    </style>
</head>
<body>
<div class="admin-layout">
    <!-- Sidebar -->
    <div th:replace="admin/fragments/admin-sidebar :: sidebar"></div>

    <!-- Main Content -->
    <div class="admin-main-content">
        <div
                class="content-header d-flex justify-content-between align-items-center"
        >
            <h1>Quản lý đơn hàng</h1>
        </div>

        <!-- Order Table -->
        <div class="card">
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                        <tr>
                            <th>Mã ĐH</th>
                            <th>Khách hàng</th>
                            <th>Ngày đặt</th>
                            <th>Tổng tiền</th>
                            <th>Trạng thái</th>
                            <th>Hành động</th>
                        </tr>
                        </thead>
                        <tbody>
                        <tr th:each="order : ${orders}">
                            <td th:text="${'#' + order.id}">ID</td>
                            <td th:text="${order.user.name}">Khách hàng</td>
                            <td
                                    th:text="${#temporals.format(order.orderDate, 'dd/MM/yyyy HH:mm')}"
                            >
                                Ngày đặt
                            </td>
                            <td
                                    th:text="${#numbers.formatDecimal(order.totalAmount, 0, 'COMMA', 0, 'POINT') + '₫'}"
                            >
                                Tổng tiền
                            </td>
                            <td>
                      <span
                              th:class="'status-badge status-' + ${#strings.toLowerCase(order.status)}"
                              th:text="${order.status}"
                      >Status</span
                      >
                            </td>
                            <td>
                                <div class="btn-group">
                                    <!-- Nút Chi tiết -->
                                    <a
                                            th:href="@{/admin/orders/{id}(id=${order.id})}"
                                            class="btn btn-sm btn-info text-white text-decoration-none"
                                    >
                                        <i class="fas fa-eye"></i> Chi tiết
                                    </a>

                                    <!-- Nút Cập nhật trạng thái -->
                                    <button
                                            class="btn btn-sm btn-primary"
                                            th:onclick="'updateStatus(' + ${order.id} + ')'"
                                    >
                                        <i class="fas fa-edit"></i> Cập nhật trạng thái
                                    </button>

                                    <!-- Nút Xóa -->
                                    <a
                                            th:href="@{/admin/orders/{id}/delete(id=${order.id})}"
                                            class="btn btn-sm btn-danger text-white text-decoration-none"
                                    >
                                        <i class="fas fa-trash"></i> Xóa
                                    </a>

                                </div>
                            </td>
                        </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>


<!-- Status Update Modal -->
<div class="modal fade" id="updateStatusModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Cập nhật trạng thái</h5>
                <button
                        type="button"
                        class="btn-close"
                        data-bs-dismiss="modal"
                ></button>
            </div>
            <div class="modal-body">
                <form id="updateStatusForm">
                    <input type="hidden" id="updateOrderId"/>
                    <div class="mb-3">
                        <label class="form-label">Trạng thái mới</label>
                        <select class="form-select" id="newStatus" name="status">
                            <option value="Pending">Chờ xác nhận</option>
                            <option value="Processing">Đã xác nhận</option>
                            <option value="Shipped">Đang giao</option>
                            <option value="Completed">Đã giao</option>
                            <option value="Cancelled">Đã hủy</option>
                        </select>
                    </div>
                    <button type="submit" class="btn btn-primary w-100">
                        Cập nhật
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Scripts -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
<script>

    // Update order status
    function updateStatus(orderId) {
        document.getElementById("updateOrderId").value = orderId;
        new bootstrap.Modal(
            document.getElementById("updateStatusModal")
        ).show();
    }

    document.getElementById("updateStatusForm").addEventListener("submit", function (e) {
        e.preventDefault();
        const orderId = document.getElementById("updateOrderId").value;
        const newStatus = document.getElementById("newStatus").value;

        fetch(`/admin/orders/${orderId}/status`, {
            method: "PUT",
            headers: {
                "Content-Type": "application/x-www-form-urlencoded",
            },
            body: new URLSearchParams({
                status: newStatus,
                returnUrl: "/admin/orders"
            }),
        }).then((response) => {
            if (response.redirected) {
                window.location.href = response.url;
            } else {
                location.reload(); // fallback
            }
        });
    });


</script>
</body>
</html>
