<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8"/>
    <title>Giỏ Hàng Của Bạn</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"/>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet"/>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <link rel="stylesheet" th:href="@{/css/global.css}" type="text/css"/>
    <style>
        .cart-table th, .cart-table td {
            vertical-align: middle;
        }

        .product-name {
            font-weight: 500;
        }

        .product-description {
            font-size: 14px;
            color: #666;
        }

        .product-price {
            color: #d9534f;
            font-weight: bold;
            font-size: 16px;
        }

        .total-amount {
            font-size: 20px;
            font-weight: bold;
            color: #d9534f;
        }

        .qr-code-section {
            display: none;
            margin-top: 20px;
        }

        .qr-code {
            max-width: 200px;
            max-height: 200px;
        }

        .measurement-info {
            background: #f8f9fa;
            border-radius: 5px;
            padding: 8px;
            margin-bottom: 5px;
        }

        .measurement-details {
            font-size: 12px;
            line-height: 1.3;
            margin-bottom: 5px;
        }

        .measurement-actions {
            display: flex;
            flex-direction: column;
            gap: 3px;
        }

        .measurement-actions .btn {
            font-size: 11px;
            padding: 2px 6px;
        }

        .size-column {
            min-width: 150px;
        }
    </style>
</head>
<body>
<div th:replace="fragments/navbar :: navbar"></div>

<div class="main-content">
    <div class="container my-5">
        <h1 class="mb-4">Giỏ Hàng Của Bạn</h1>

        <div th:if="${cartItems == null or #lists.isEmpty(cartItems)}" class="text-center py-5">
            <i class="bi bi-cart-x display-1 text-muted"></i>
            <h3 class="mt-3 text-muted">Giỏ hàng của bạn đang trống</h3>
            <a href="/products" class="btn btn-primary mt-3">Tiếp tục mua sắm</a>
        </div>

        <div th:if="${cartItems != null and not #lists.isEmpty(cartItems)}">
            <table class="table cart-table">
                <thead class="table-light">
                <tr>
                    <th>Sản phẩm</th>
                    <th class="size-column">Size & Số đo</th>
                    <th>Phụ kiện</th>
                    <th>Số lượng</th>
                    <th>Giá</th>
                    <th>Thành tiền</th>
                    <th></th>
                </tr>
                </thead>
                <tbody>
                <tr th:each="item, iterStat : ${cartItems}">
                    <td>
                        <div class="product-name" th:text="${item.product.name}">Tên sản phẩm</div>
                        <div class="product-description" th:text="${item.product.description}">Mô tả sản phẩm</div>
                    </td>
                    <td class="size-column">
                        <div th:if="${item.measurement != null}" class="measurement-info text-center">
                            <div class="mb-2">
                                <strong>Số đo tùy chỉnh</strong><br>
                                <div class="measurement-details text-primary">
                                    <div th:if="${item.measurement.bustSize != null}">Ngực: [[${item.measurement.bustSize}]]cm</div>
                                    <div th:if="${item.measurement.waistSize != null}">Eo: [[${item.measurement.waistSize}]]cm</div>
                                    <div th:if="${item.measurement.hipsSize != null}">Hông: [[${item.measurement.hipsSize}]]cm</div>
                                </div>
                                <small class="text-muted" th:text="${item.measurement.note}">Ghi chú</small>
                            </div>
                            <div class="measurement-actions">
                                <button type="button" class="btn btn-sm btn-outline-primary"
                                        th:data-item-index="${iterStat.index}"
                                        data-bs-toggle="modal" data-bs-target="#measurementModal">
                                    <i class="bi bi-pencil"></i> Sửa số đo
                                </button>
                            </div>
                        </div>
                        <div th:if="${item.measurement == null}" class="text-center">
                            <span class="text-muted d-block mb-2" th:if="${item.size != null}">Size: [[${item.size}]]</span>
                            <span class="text-muted d-block mb-2" th:if="${item.size == null}">Chưa chọn size</span>
                            <button type="button" class="btn btn-sm btn-outline-primary"
                                    th:data-item-index="${iterStat.index}"
                                    data-bs-toggle="modal" data-bs-target="#measurementModal">
                                <i class="bi bi-plus"></i> Thêm số đo riêng
                            </button>
                        </div>
                    </td>
                    <td>
                        <ul th:if="${item.decorations != null and not #lists.isEmpty(item.decorations)}" class="list-unstyled">
                            <li th:each="d : ${item.decorations}"
                                th:text="${d.name + ' (' + #numbers.formatDecimal(d.extraPrice, 0, 'COMMA', 0, 'POINT') + '₫)'}"></li>
                        </ul>
                        <span th:if="${item.decorations == null or #lists.isEmpty(item.decorations)}">-</span>
                    </td>
                    <td th:text="${item.quantity}">1</td>
                    <td class="product-price"
                        th:text="${#numbers.formatDecimal(item.product.price, 0, 'COMMA', 0, 'POINT')} + '₫'">0
                    </td>

                    <td class="product-price"
                        th:text="${#numbers.formatDecimal(item.totalPrice, 0, 'COMMA', 0, 'POINT')} + '₫'">0
                    </td>

                    <td>
                        <form th:action="@{/cart/remove}" method="post">
                            <input type="hidden" name="index" th:value="${iterStat.index}"/>
                            <button type="submit" class="btn btn-link text-danger p-0"><i class="bi bi-trash"></i></button>
                        </form>
                    </td>
                </tr>
                </tbody>
            </table>

            <div class="d-flex justify-content-between align-items-center mt-4 flex-wrap gap-2">
                <a href="/products" class="btn btn-link"><i class="bi bi-arrow-left"></i> Tiếp tục mua hàng</a>

                <div class="total-amount">
                    TỔNG:
                    <span th:text="${#numbers.formatDecimal(total, 0, 'COMMA', 0, 'POINT')} + '₫'">0</span>
                </div>

                <div class="d-flex gap-2">
                    <form th:action="@{/cart/clear}" method="post">
                        <button type="submit" class="btn btn-outline-secondary">XÓA HẾT</button>
                    </form>
                    <button type="button" class="btn btn-dark" data-bs-toggle="modal" data-bs-target="#checkoutModal">
                        TIẾN HÀNH THANH TOÁN
                    </button>
                </div>
            </div>
        </div>
    </div>
    <!-- Modal Thanh Toán -->
    <div class="modal fade" id="checkoutModal" tabindex="-1" aria-labelledby="checkoutModalLabel" aria-hidden="true"
         data-bs-backdrop="static">
        <div class="modal-dialog">
            <div class="modal-content">
                <form th:action="@{/order/checkout}" method="post" id="checkoutForm" class="needs-validation" novalidate>
                    <div class="modal-header">
                        <h5 class="modal-title" id="checkoutModalLabel">Thông tin thanh toán</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <div class="mb-3">
                            <label for="customerName" class="form-label">Họ và tên</label>
                            <input type="text" class="form-control" id="customerName" name="customerName" required>
                        </div>
                        <div class="mb-3">
                            <label for="customerPhone" class="form-label">Số điện thoại</label>
                            <input type="text" class="form-control" id="customerPhone" name="customerPhone" required>
                        </div>
                        <div class="mb-3">
                            <label for="customerEmail" class="form-label">Email</label>
                            <input type="email" class="form-control" id="customerEmail" name="customerEmail" required>
                        </div>
                        <div class="mb-3">
                            <label for="shippingAddressDetail" class="form-label">Địa chỉ giao hàng *</label>
                            <input type="text" class="form-control" id="shippingAddressDetail" name="shippingAddressDetail" required minlength="10" maxlength="200">
                        </div>
                        <div class="mb-3">
                            <label for="city" class="form-label">Thành phố *</label>
                            <select id="city" name="city" class="form-control" required>
                                <option value="">-- Chọn thành phố --</option>
                                <option value="hcm">TP Hồ Chí Minh</option>
                                <option value="hn">Hà Nội</option>
                                <option value="dn">Đà Nẵng</option>
                                <option value="ct">Cần Thơ</option>
                                <option value="hp">Hải Phòng</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="ward" class="form-label">Xã *</label>
                            <select id="ward" name="ward" class="form-control" required>
                                <option value="">-- Chọn xã --</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="paymentMethod" class="form-label">Phương thức thanh toán *</label>
                            <select id="paymentMethod" name="paymentMethod" class="form-control" required>
                                <option value="">-- Chọn phương thức --</option>
                                <option value="cod">Thanh toán khi nhận hàng (COD)</option>
                                <option value="bank">Chuyển khoản ngân hàng</option>
                            </select>
                        </div>

                        <div id="bankTransferDetails" class="qr-code-section">
                            <p><strong>Ngân hàng:</strong> ACB</p>
                            <p><strong>Chủ tài khoản:</strong> Trần Xuân Bắc</p>
                            <p><strong>Số tiền cần chuyển:</strong> <span th:text="${#numbers.formatDecimal(total, 0, 'COMMA', 0, 'POINT')} + '₫'">0</span></p>
                            <img id="qrCode" class="qr-code" src="" alt="QR Code"/>
                        </div>

                        <input type="hidden" name="userId" value="1"/>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
                        <button type="submit" class="btn btn-dark">Xác nhận thanh toán</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Modal Nhập Số Đo -->
    <div class="modal fade" id="measurementModal" tabindex="-1" aria-labelledby="measurementModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <form th:action="@{/cart/update-measurement}" method="post" id="measurementForm">
                    <div class="modal-header">
                        <h5 class="modal-title" id="measurementModalLabel">Nhập Số Đo Riêng</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <input type="hidden" name="itemIndex" id="itemIndex">

                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="bustSize" class="form-label">Vòng ngực (cm)</label>
                                    <input type="number" step="0.1" class="form-control" id="bustSize" name="bustSize">
                                </div>
                                <div class="mb-3">
                                    <label for="waistSize" class="form-label">Vòng eo (cm)</label>
                                    <input type="number" step="0.1" class="form-control" id="waistSize" name="waistSize">
                                </div>
                                <div class="mb-3">
                                    <label for="hipsSize" class="form-label">Vòng hông (cm)</label>
                                    <input type="number" step="0.1" class="form-control" id="hipsSize" name="hipsSize">
                                </div>
                                <div class="mb-3">
                                    <label for="armLength" class="form-label">Dài tay (cm)</label>
                                    <input type="number" step="0.1" class="form-control" id="armLength" name="armLength">
                                </div>
                                <div class="mb-3">
                                    <label for="shoulderWidth" class="form-label">Rộng vai (cm)</label>
                                    <input type="number" step="0.1" class="form-control" id="shoulderWidth" name="shoulderWidth">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="buttSize" class="form-label">Vòng mông (cm)</label>
                                    <input type="number" step="0.1" class="form-control" id="buttSize" name="buttSize">
                                </div>
                                <div class="mb-3">
                                    <label for="hipDrop" class="form-label">Chiều dài từ eo xuống hông (cm)</label>
                                    <input type="number" step="0.1" class="form-control" id="hipDrop" name="hipDrop">
                                </div>
                                <div class="mb-3">
                                    <label for="neckSize" class="form-label">Vòng cổ (cm)</label>
                                    <input type="number" step="0.1" class="form-control" id="neckSize" name="neckSize">
                                </div>
                                <div class="mb-3">
                                    <label for="skirtLength" class="form-label">Chiều dài váy (cm)</label>
                                    <input type="number" step="0.1" class="form-control" id="skirtLength" name="skirtLength">
                                </div>
                                <div class="mb-3">
                                    <label for="waistDrop" class="form-label">Chiều dài từ vai xuống eo (cm)</label>
                                    <input type="number" step="0.1" class="form-control" id="waistDrop" name="waistDrop">
                                </div>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label for="measurementNote" class="form-label">Ghi chú</label>
                            <textarea class="form-control" id="measurementNote" name="note" rows="2"
                                      placeholder="Thêm ghi chú về số đo (ví dụ: đo buổi sáng, mặc áo mỏng...)"></textarea>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
                        <button type="submit" class="btn btn-primary">Lưu số đo</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>





<script>
    const wardOptions = {
        hcm: [
            {value: 'phu_nhuan', text: 'Phú Nhuận'},
            {value: 'ben_nghe', text: 'Bến Nghé'},
            {value: 'tan_dinh', text: 'Tân Định'}
        ],
        hn: [
            {value: 'dong_da', text: 'Đống Đa'},
            {value: 'hoan_kiem', text: 'Hoàn Kiếm'},
            {value: 'ba_dinh', text: 'Ba Đình'}
        ],
        dn: [
            {value: 'hai_chau', text: 'Hải Châu'},
            {value: 'thanh_khe', text: 'Thanh Khê'},
            {value: 'son_tra', text: 'Sơn Trà'}
        ],
        ct: [
            {value: 'ninh_kieu', text: 'Ninh Kiều'},
            {value: 'binh_thuy', text: 'Bình Thủy'},
            {value: 'cai_rang', text: 'Cái Răng'}
        ],
        hp: [
            {value: 'ngo_quyen', text: 'Ngô Quyền'},
            {value: 'le_chan', text: 'Lê Chân'},
            {value: 'kien_an', text: 'Kiến An'}
        ]
    };

    function updateWardOptions() {
        const city = document.getElementById('city').value;
        const wardSelect = document.getElementById('ward');
        wardSelect.innerHTML = '<option value="">-- Chọn xã --</option>';
        if (wardOptions[city]) {
            wardOptions[city].forEach(function (ward) {
                const opt = document.createElement('option');
                opt.value = ward.value;
                opt.text = ward.text;
                wardSelect.appendChild(opt);
            });
        }
    }

    function showBankTransferDetails() {
        const method = document.getElementById('paymentMethod').value;
        const qrSection = document.getElementById('bankTransferDetails');
        const qrImg = document.getElementById('qrCode');
        const amount = document.querySelector('.total-amount span')?.innerText ?? '0';

        if (method === 'bank') {
            qrSection.style.display = 'block';
            qrImg.src = 'https://api.qrserver.com/v1/create-qr-code/?size=150x150&data=' + encodeURIComponent(`${amount} ACB Trần Xuân Bắc`);
        } else {
            qrSection.style.display = 'none';
        }
    }

    // Debug modal functionality
    document.addEventListener('DOMContentLoaded', function() {
        // Add event listeners for city and payment method changes
        const citySelect = document.getElementById('city');
        const paymentMethodSelect = document.getElementById('paymentMethod');
        
        if (citySelect) {
            citySelect.addEventListener('change', updateWardOptions);
        }
        
        if (paymentMethodSelect) {
            paymentMethodSelect.addEventListener('change', showBankTransferDetails);
        }

        const checkoutButton = document.querySelector('[data-bs-target="#checkoutModal"]');
        const modal = document.getElementById('checkoutModal');

        if (checkoutButton && modal) {
            checkoutButton.addEventListener('click', function(e) {
                console.log('Checkout button clicked');
                const bsModal = new bootstrap.Modal(modal);
                bsModal.show();

                modal.addEventListener('shown.bs.modal', function () {
                    const firstButton = modal.querySelector('button, [tabindex]:not([tabindex="-1"])');
                    if (firstButton) {
                        firstButton.focus();
                    } else {
                        modal.focus();
                    }
                }, { once: true });

                // Khi modal ẩn (cả nhấn hủy, đóng, submit), trả focus về nút mở modal
                modal.addEventListener('hidden.bs.modal', function () {
                    checkoutButton.focus();
                }, { once: true });
            });
        }
        
        // Handle measurement modal
        const measurementModal = document.getElementById('measurementModal');
        const measurementButtons = document.querySelectorAll('[data-bs-target="#measurementModal"]');
        
        // Handle measurement editing
        measurementButtons.forEach(button => {
            button.addEventListener('click', function() {
                const itemIndex = this.getAttribute('data-item-index');
                document.getElementById('itemIndex').value = itemIndex;
                
                // Reset form
                const form = document.getElementById('measurementForm');
                form.reset();
                document.getElementById('itemIndex').value = itemIndex;
            });
        });
        
        // Form validation
        const forms = document.querySelectorAll('.needs-validation');
        Array.from(forms).forEach(form => {
            form.addEventListener('submit', event => {
                if (!form.checkValidity()) {
                    event.preventDefault();
                    event.stopPropagation();
                }
                form.classList.add('was-validated');
            }, false);
        });
    });
</script>

<!-- Bootstrap JavaScript -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

</body>
</html>

