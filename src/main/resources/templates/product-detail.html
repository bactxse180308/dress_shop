<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="vi">
<head>
    <meta charset="UTF-8"/>
    <title th:text="${product.name}">Chi Tiết Sản Phẩm</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet"
          integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">
    <link rel="stylesheet" th:href="@{/css/product-detail.css}" type="text/css"/>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
    <link rel="stylesheet" th:href="@{/css/global.css}" type="text/css"/>
  
</head>
<body>
<!-- Navigation -->
<div th:replace="fragments/navbar :: navbar"></div>

<!-- Main content -->
<div class="container my-5">
    <div class="row">
        <!-- Vùng ảnh sản phẩm (gallery) -->
        <div class="col-lg-6 mb-4 mb-lg-0">
            <div class="product-gallery-container">
                <!-- Thumbnails -->
                <div class="product-thumbnails">
                    <img th:each="image, iterStat : ${product.images}"
                         th:src="@{${image.imageUrl}}"
                         th:classappend="${iterStat.index == 0} ? 'active' : ''"
                         class="img-thumbnail"
                         th:onclick="|changeMainImage(this)|"/>
                </div>
                <!-- Main Image -->
                <div class="main-image-container">
                    <img th:if="${!product.images.isEmpty()}"
                         th:src="@{${product.images[0].imageUrl}}"
                         class="img-fluid rounded" id="main-image" alt="Product Image"/>
                    <img th:if="${product.images.isEmpty()}"
                         th:src="@{/images/placeholder.jpg}"
                         class="img-fluid rounded" id="main-image" alt="No Image"/>
                </div>
            </div>
        </div>

        <!-- Vùng thông tin sản phẩm -->
        <div class="col-lg-6 product-info">
            <h1 class="product-name" th:text="${product.name}">Tên sản phẩm</h1>
            <p class="product-code">MÃ SẢN PHẨM: <span th:text="${product.id}"></span></p>
            <p class="product-price"
                th:text="${#numbers.formatDecimal(product.price,0,'COMMA',0,'POINT')} + '₫'"
                th:attr="data-base-price=${product.price}">
                Giá
            </p>

            <!-- Form thêm vào giỏ hàng -->
            <form th:action="@{/cart/add}" method="post" id="addToCartForm">
                <input type="hidden" name="productId" th:value="${product.id}"/>
                <input type="hidden" name="quantity" id="quantityHidden" value="1"/>
                <input type="hidden" name="size" id="sizeHidden"/>

                <!-- Chọn size -->
                <div class="mb-4">
                    <label class="form-label fw-bold">KÍCH THƯỚC</label>
                    <div class="d-flex align-items-center gap-2 flex-wrap size-buttons">
                        <button type="button" class="btn btn-outline-secondary size-btn">S</button>
                        <button type="button" class="btn btn-outline-secondary size-btn">M</button>
                        <button type="button" class="btn btn-outline-secondary size-btn">L</button>
                        <button type="button" class="btn btn-outline-secondary size-btn">XL</button>
                        <button type="button" class="btn btn-outline-secondary size-btn">XXL</button>
                        <a href="#" class="ms-3 size-guide-link">Hướng dẫn chọn size</a>
                    </div>
                </div>
                <div class="form-check mb-4">
                    <input class="form-check-input" type="checkbox"
                           id="customSizing" name="customSizing" value="true"/>
                    <label class="form-check-label" for="customSizing">
                        Tôi muốn nhập số đo chi tiết
                    </label>
                </div>

                <!-- Phần nhập số đo chi tiết (hiển thị khi customSizing checked) -->
                <div th:if="${param.customSizing}">
                    <div class="row g-3 mb-4">
                        <div class="col-md-6">
                            <label for="bustSize" class="form-label">Bust Size (cm)</label>
                            <input type="number" step="0.1" class="form-control"
                                   id="bustSize" name="bustSize"/>
                        </div>
                        <div class="col-md-6">
                            <label for="waistSize" class="form-label">Waist Size (cm)</label>
                            <input type="number" step="0.1" class="form-control"
                                   id="waistSize" name="waistSize"/>
                        </div>
                        <div class="col-md-6">
                            <label for="hipsSize" class="form-label">Hips Size (cm)</label>
                            <input type="number" step="0.1" class="form-control"
                                   id="hipsSize" name="hipsSize"/>
                        </div>
                        <div class="col-md-6">
                            <label for="buttSize" class="form-label">Butt Size (cm)</label>
                            <input type="number" step="0.1" class="form-control"
                                   id="buttSize" name="buttSize"/>
                        </div>
                        <div class="col-md-6">
                            <label for="armLength" class="form-label">Arm Length (cm)</label>
                            <input type="number" step="0.1" class="form-control"
                                   id="armLength" name="armLength"/>
                        </div>
                        <div class="col-md-6">
                            <label for="shoulderWidth" class="form-label">Shoulder Width (cm)</label>
                            <input type="number" step="0.1" class="form-control"
                                   id="shoulderWidth" name="shoulderWidth"/>
                        </div>
                        <div class="col-md-6">
                            <label for="skirtLength" class="form-label">Skirt Length (cm)</label>
                            <input type="number" step="0.1" class="form-control"
                                   id="skirtLength" name="skirtLength"/>
                        </div>
                        <div class="col-md-6">
                            <label for="waistDrop" class="form-label">Waist Drop (cm)</label>
                            <input type="number" step="0.1" class="form-control"
                                   id="waistDrop" name="waistDrop"/>
                        </div>
                        <div class="col-md-6">
                            <label for="hipDrop" class="form-label">Hip Drop (cm)</label>
                            <input type="number" step="0.1" class="form-control"
                                   id="hipDrop" name="hipDrop"/>
                        </div>
                        <div class="col-md-6">
                            <label for="neckSize" class="form-label">Neck Size (cm)</label>
                            <input type="number" step="0.1" class="form-control"
                                   id="neckSize" name="neckSize"/>
                        </div>
                        <div class="col-12">
                            <label for="note" class="form-label">Ghi chú thêm</label>
                            <textarea class="form-control" id="note"
                                      name="note" rows="2"></textarea>
                        </div>
                    </div>
                </div>

                <!-- Chọn số lượng -->
                <div class="mb-4">
                    <label for="quantityInput" class="form-label fw-bold">SỐ LƯỢNG</label>
                    <div class="input-group quantity-group">
                        <button class="btn btn-outline-secondary" type="button" id="decreaseQty">-</button>
                        <input type="text" id="quantityInput" class="form-control text-center" value="1" readonly/>
                        <button class="btn btn-outline-secondary" type="button" id="increaseQty">+</button>
                    </div>
                </div>

                <!-- Chọn trang trí -->
                <div class="mb-4" th:if="${!decorations.isEmpty()}">
                    <label class="form-label fw-bold">TRANG TRÍ THÊM</label>
                    <div class="decorations-container">
                        <div class="form-check" th:each="decoration : ${decorations}">
                            <input class="form-check-input decoration-checkbox" type="checkbox"
                                   th:value="${decoration.id}" th:id="'decoration-' + ${decoration.id}"
                                   name="decorationIds"/>
                            <label class="form-check-label" th:for="'decoration-' + ${decoration.id}">
                                <span th:text="${decoration.name}">Tên trang trí</span>
                                <span class="decoration-price"
                                      th:text="'+' + ${#numbers.formatDecimal(decoration.extraPrice,0,'COMMA',0,'POINT')} + '₫'">
                                    Giá
                                </span>
                            </label>
                        </div>
                    </div>
                </div>

                <!-- Action Buttons -->
                <div class="d-grid gap-3 action-buttons">
                    <button type="submit" class="btn btn-add-to-cart">THÊM VÀO GIỎ</button>
                    <button type="submit" class="btn btn-buy-now">MUA NGAY</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Mô tả sản phẩm và đánh giá -->
    <div class="row mt-5">
        <div class="col-12 product-details-section">
            <h5 class="fw-bold">MÔ TẢ SẢN PHẨM</h5>
            <p th:text="${product.description}">Mô tả sản phẩm sẽ hiển thị ở đây.</p>
        </div>

        <div class="col-12 mt-4 product-details-section">
            <h5 class="fw-bold">ĐÁNH GIÁ SẢN PHẨM</h5>
            <p th:if="${reviews.isEmpty()}" class="text-muted">Chưa có đánh giá nào cho sản phẩm này.</p>
            <div th:each="review : ${reviews}" class="border p-3 mb-3 rounded">
                <div class="d-flex align-items-center mb-2">
                    <i class="fas fa-user-circle fs-4 me-2"></i>
                    <strong th:text="${review.user.name}">Người dùng</strong>
                </div>
                <div class="d-flex align-items-center mb-2">
                    <span th:each="i : ${#numbers.sequence(1, 5)}">
                        <i class="fas fa-star" th:classappend="${i <= review.rating} ? 'text-warning' : 'text-secondary'"></i>
                    </span>
                </div>
                <p th:text="${review.comment}" class="mb-0">Nội dung đánh giá.</p>
            </div>
        </div>
    </div>
</div>

<!-- Footer -->
<div th:replace="fragments/footer :: footer"></div>

<script>
    // Image gallery handling
    function changeMainImage(imgElement) {
        document.getElementById('main-image').src = imgElement.src;
        document.querySelectorAll('.product-thumbnails img').forEach(function (elem) {
            elem.classList.remove('active');
        });
        imgElement.classList.add('active');
    }

    // Size button selection
    const sizeButtons = document.querySelectorAll(".size-btn");
    const sizeHidden = document.getElementById("sizeHidden");

    sizeButtons.forEach((btn) => {
        btn.addEventListener("click", () => {
            sizeButtons.forEach((b) => b.classList.remove("active"));
            btn.classList.add("active");
            sizeHidden.value = btn.textContent.trim();
        });
    });

    // Quantity handling
    const qtyInput = document.getElementById("quantityInput");
    const qtyHidden = document.getElementById("quantityHidden");
    const increaseBtn = document.getElementById("increaseQty");
    const decreaseBtn = document.getElementById("decreaseQty");

    increaseBtn.addEventListener("click", () => {
        let val = parseInt(qtyInput.value);
        qtyInput.value = val + 1;
        qtyHidden.value = val + 1;
    });

    decreaseBtn.addEventListener("click", () => {
        let val = parseInt(qtyInput.value);
        if (val > 1) {
            qtyInput.value = val - 1;
            qtyHidden.value = val - 1;
        }
    });

    // Form validation before submit
    const addToCartForm = document.getElementById('addToCartForm');
    const customSizingCheckbox = document.getElementById('customSizing');
    
    addToCartForm.addEventListener('submit', function(event) {
        // Chỉ bắt buộc chọn size nếu KHÔNG tick "nhập số đo"
        if (!customSizingCheckbox.checked && !sizeHidden.value) {
            alert('Vui lòng chọn kích thước sản phẩm hoặc tick "Tôi muốn nhập số đo chi tiết".');
            event.preventDefault(); // Prevent form submission
        }
    });

</script>
</body>
</html>
