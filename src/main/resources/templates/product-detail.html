<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="vi">
<head>
    <meta charset="UTF-8"/>
    <title th:text="${product.name}">Chi Tiết Sản Phẩm</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet"
          integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">
    <link rel="stylesheet" th:href="@{/css/product-detail.css}" type="text/css"/>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
    <link rel="stylesheet" th:href="@{/css/global.css}" type="text/css"/>
</head>
<body>
<!-- Navigation -->
<div th:replace="fragments/navbar :: navbar"></div>
<!-- Main content -->
<div class="main-content">
    <div class="container my-5">
        <div class="d-flex align-items-start">
            <!-- Vùng ảnh sản phẩm (gallery) -->
            <div class="product-gallery d-flex">
                <!-- Thumbnails dọc -->
                <div class="product-thumbnails d-flex flex-column me-3">
                    <img
                            th:each="image, iterStat : ${product.images}"
                            th:src="@{${image.imageUrl}}"
                            th:classappend="${iterStat.index == 0} ? 'active' : ''"
                            class="img-thumbnail mb-2"
                            style="cursor: pointer"
                            th:onclick="|changeMainImage(this)|"
                    />
                </div>
                <!-- Ảnh chính -->
                <div>
                    <img
                            th:if="${!product.images.isEmpty()}"
                            th:src="@{${product.images[0].imageUrl}}"
                            class="img-fluid"
                            id="main-image"
                            alt="Product Image"
                    />
                    <img
                            th:if="${product.images.isEmpty()}"
                            th:src="@{/images/placeholder.jpg}"
                            class="img-fluid"
                            id="main-image"
                            alt="No Image"
                    />
                    <!-- Mô tả sản phẩm nằm dưới ảnh chính (hoặc di chuyển ra ngoài .product-gallery nếu muốn nằm bên phải ảnh) -->
                    <div class="product-description mt-3">
                        <h5 class="fw-bold">MÔ TẢ SẢN PHẨM</h5>
                        <p th:text="${product.description}">Mô tả sản phẩm sẽ hiển thị ở đây.</p>
                        <div class="d-flex align-items-center">
                        </div>
                    </div>
                    <div class="mt-3">
                        <h5 class="fw-bold">ĐÁNH GIÁ SẢN PHẨM</h5>
                        <p th:if="${reviews.isEmpty()}" class="text-muted">Chưa có đánh giá nào cho sản phẩm này.</p>
                        <div th:each="reviews : ${reviews}"
                             class="reviews-list">
                            <div class="border p-2 mb-2">
                                <div class="d-flex align-items-center mb-1">
                                    <i class="fas fa-user-circle me-2"></i>
                                    <strong th:text="${reviews.getUser().getName()}">Người dùng</strong>
                                </div>
                                <p th:text="${reviews.getComment()}">Đánh giá sản phẩm sẽ hiển thị ở đây.</p>
                                <div class="d-flex align-items-center">
                                    <span th:each="i : ${#numbers.sequence(1, 5)}">
                                        <i class="fas fa-star" th:classappend="${i <= reviews.rating} ? 'text-warning' : 'text-secondary'"></i>
                                    </span>
                                </div>
                            </div>

                        </div>
                    </div>
                </div>
            </div>
            <!-- Vùng thông tin sản phẩm -->
            <div class="product-info ms-5 flex-grow-1">
                <h4 class="fw-bold mb-2" th:text="${product.name}">Tên sản phẩm</h4>
                <p class="mb-1 text-muted">
                    MÃ SẢN PHẨM: <span th:text="${product.id}"></span>
                </p>
                <h3
                        class="text-danger fw-bold mb-4"
                        th:text="${#numbers.formatDecimal(product.price,0,'COMMA',0,'POINT')} + '₫'"
                        th:attr="data-base-price=${product.price}"
                >
                    Giá
                </h3>

                <!-- Chọn size -->
                <div class="mb-3">
                    <label class="form-label fw-bold">KÍCH THƯỚC</label><br/>
                    <div class="d-flex flex-wrap gap-2" id="sizeButtons">
                        <button type="button" class="btn btn-outline-secondary size-btn">S</button>
                        <button type="button" class="btn btn-outline-secondary size-btn">M</button>
                        <button type="button" class="btn btn-outline-secondary size-btn">L</button>
                        <button type="button" class="btn btn-outline-secondary size-btn">XL</button>
                        <button type="button" class="btn btn-outline-secondary size-btn">XXL</button>
                        <a href="#" class="ms-2">Hướng dẫn chọn size</a>
                    </div>
                </div>

                <!-- Chọn số lượng -->
                <div class="mb-3">
                    <label class="form-label fw-bold">SỐ LƯỢNG</label><br/>
                    <div class="input-group quantity-group" style="width: 130px">
                        <button class="btn btn-outline-secondary" type="button" id="decreaseQty">-</button>
                        <input type="text" id="quantityInput" class="form-control text-center" value="1"/>
                        <button class="btn btn-outline-secondary" type="button" id="increaseQty">+</button>
                    </div>
                </div>

                <!-- Chọn trang trí -->
                <div class="mb-3">
                    <label class="form-label fw-bold">TRANG TRÍ THÊM</label>
                    <div class="decorations-container">
                        <div class="form-check" th:each="decoration : ${decorations}">
                            <input class="form-check-input decoration-checkbox" type="checkbox"
                                   th:value="${decoration.id}" th:id="'decoration-' + ${decoration.id}"
                                   name="decorations"/>
                            <label class="form-check-label d-flex justify-content-between align-items-center"
                                   th:for="'decoration-' + ${decoration.id}">
                                <span th:text="${decoration.name}">Tên trang trí</span>
                                <span class="text-danger"
                                      th:text="${#numbers.formatDecimal(decoration.extraPrice,0,'COMMA',0,'POINT')} + '₫'">
                                Giá
                            </span>
                            </label>
                        </div>
                    </div>
                </div>

                <!-- Form thêm vào giỏ -->
                <form th:action="@{/cart/add}" method="post" id="addToCartForm" class="d-flex gap-2 mt-4 flex-wrap">
                    <input type="hidden" name="productId" th:value="${product.id}"/>
                    <input type="hidden" name="quantity" id="quantityHidden" value="1"/>
                    <input type="hidden" name="size" id="sizeHidden"/>
                    <input type="hidden" name="selectedDecorations" id="selectedDecorations" value=""/>

                    <button type="submit" class="btn btn-dark flex-fill py-2">THÊM VÀO GIỎ</button>
                    <a href="/cart" class="btn btn-danger flex-fill py-2">MUA NGAY</a>
                </form>
            </div>
        </div>
    </div>
</div>

<div th:replace="fragments/footer :: footer"></div>
<script>

    function changeMainImage(imgElement) {
        // Đổi src ảnh lớn
        document.getElementById('main-image').src = imgElement.src;

        // Xóa class active ở tất cả thumbnail
        document.querySelectorAll('.product-thumbnails img').forEach(function(elem){
            elem.classList.remove('active');
        });
        // Thêm class active vào thumbnail vừa click
        imgElement.classList.add('active');
    }

    // Xử lý chọn size
    const sizeButtons = document.querySelectorAll(".size-btn");
    const sizeHidden = document.getElementById("sizeHidden");

    sizeButtons.forEach((btn) => {
        btn.addEventListener("click", () => {
            sizeButtons.forEach((b) => b.classList.remove("active"));
            btn.classList.add("active");
            sizeHidden.value = btn.textContent.trim();
        });
    });

    // Tăng giảm số lượng
    const qtyInput = document.getElementById("quantityInput");
    const qtyHidden = document.getElementById("quantityHidden");
    document.getElementById("increaseQty").addEventListener("click", () => {
        let val = parseInt(qtyInput.value || "1");
        qtyInput.value = val + 1;
        qtyHidden.value = val + 1;
    });
    document.getElementById("decreaseQty").addEventListener("click", () => {
        let val = parseInt(qtyInput.value || "1");
        if (val > 1) {
            qtyInput.value = val - 1;
            qtyHidden.value = val - 1;
        }
    });
    qtyInput.addEventListener("input", () => {
        let val = parseInt(qtyInput.value || "1");
        if (val < 1 || isNaN(val)) val = 1;
        qtyInput.value = val;
        qtyHidden.value = val;
    });

    // Kiểm tra size khi submit
    document
        .getElementById("addToCartForm")
        .addEventListener("submit", function (e) {
            if (!sizeHidden.value) {
                e.preventDefault();
                alert("Vui lòng chọn kích thước!");
                return;
            }

            // Collect selected decorations
            const selectedDecorations = [];
            document
                .querySelectorAll(".decoration-checkbox:checked")
                .forEach((checkbox) => {
                    selectedDecorations.push(checkbox.value);
                });
            document.getElementById("selectedDecorations").value =
                selectedDecorations.join(",");
        });

    // Handle decoration selection and price update
    function updateTotalPrice() {
        // Always get the raw base price from the data attribute
        const basePriceEl = document.querySelector(".text-danger.fw-bold");
        if (!basePriceEl) return;
        const basePrice = Number(basePriceEl.getAttribute("data-base-price"));
        if (isNaN(basePrice)) return;

        let totalPrice = basePrice;

        // Add selected decorations' prices
        document
            .querySelectorAll(".decoration-checkbox:checked")
            .forEach((checkbox) => {
                const priceEl = checkbox.parentElement.querySelector(".text-danger");
                if (!priceEl) return;
                const decorationPrice = Number(priceEl.textContent.replace(/[^\d]/g, ""));
                if (!isNaN(decorationPrice)) totalPrice += decorationPrice;
            });

        // Get quantity, default to 1 if invalid
        const quantityInput = document.getElementById("quantityInput");
        const quantity = Number(quantityInput?.value) || 1;

        // Calculate total
        totalPrice *= quantity;

        // Update displayed price (only the visible text, not the data attribute)
        basePriceEl.textContent =
            new Intl.NumberFormat("vi-VN").format(totalPrice) + "₫";
    }

    // Add event listeners for decoration checkboxes
    document
        .querySelectorAll(".decoration-checkbox")
        .forEach((checkbox) => {
            checkbox.addEventListener("change", updateTotalPrice);
        });

    // Update price when quantity changes
    document
        .getElementById("quantityInput")
        .addEventListener("input", updateTotalPrice);
    document
        .getElementById("increaseQty")
        .addEventListener("click", updateTotalPrice);
    document
        .getElementById("decreaseQty")
        .addEventListener("click", updateTotalPrice);
</script>
</body>
</html>