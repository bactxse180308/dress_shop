<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
  <title>Chi tiết đơn hàng</title>
  <link
          href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css"
          rel="stylesheet"
  />
  <link
          rel="stylesheet"
          href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css"
  />
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" th:href="@{/css/global.css}" type="text/css" />
  <link rel="stylesheet" th:href="@{/style/order_detail.css}" type="text/css" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
  <style>
    .measurement-details {
      background: #f8f9fa;
      border-radius: 8px;
      padding: 12px;
      margin-top: 8px;
      border-left: 4px solid #007bff;
    }
    .measurement-item {
      display: inline-block;
      background: #e3f2fd;
      padding: 4px 10px;
      margin: 3px 2px;
      border-radius: 6px;
      font-size: 13px;
      font-weight: 500;
      color: #1976d2;
      border: 1px solid #bbdefb;
    }
    .measurement-item i {
      margin-right: 4px;
      color: #1976d2;
    }
    .measurement-note {
      font-style: italic;
      color: #666;
      margin-top: 8px;
      padding: 6px;
      background: #fff3e0;
      border-radius: 4px;
      border-left: 3px solid #ff9800;
    }
    .size-badge {
      display: inline-block;
      background: #28a745;
      color: white;
      padding: 6px 12px;
      border-radius: 6px;
      font-weight: 600;
      font-size: 14px;
    }
    .product-table {
      font-size: 14px;
    }
    .product-table th {
      background-color: #f8f9fa;
      font-weight: 600;
      text-align: center;
      vertical-align: middle;
    }
    .product-table td {
      vertical-align: middle;
    }
    @media (max-width: 768px) {
      .measurement-item {
        display: block;
        margin: 2px 0;
      }
    }
  </style>
</head>
<body>
<!-- Navigation -->
<div th:replace="fragments/navbar :: navbar"></div>

<div class="main-content">
  <div class="container">
    <div class="order-details">
      <h1 class="order-title">
        Chi tiết đơn hàng #<span th:text="${order.id}">0</span>
      </h1>

      <div class="order-info">
        <p>
          <strong>Ngày đặt:</strong>
          <span
                  th:text="${#temporals.format(order.orderDate, 'dd/MM/yyyy HH:mm')}">01/01/2025</span>
        </p>
        <p>
          <strong>Trạng thái:</strong>
          <span th:text="${order.status}">Đang xử lý</span>
        </p>
        <p>
          <strong>Tổng tiền:</strong>
          <span class="total-price" th:text="${#numbers.formatDecimal(order.totalAmount, 0, 'COMMA', 0, 'POINT')}">0</span> VND
        </p>
        <p>
          <strong>Địa chỉ giao hàng:</strong>
          <span th:text="${order.shippingAddressDetail}">Số 123, Đường ABC, Quận 1, TP.HCM</span>
        </p>
        <p>
          <strong>Phương thức thanh toán:</strong>
          <span th:text="${order.paymentMethod}">Thanh toán khi nhận hàng (COD)</span>
        </p>
      </div>

      <h2 class="section-title">Danh sách sản phẩm</h2>
      <table class="product-table table table-striped">
        <thead>
        <tr>
          <th>Hình ảnh</th>
          <th>Sản phẩm</th>
          <th>Size</th>
          <th>Phụ kiện</th>
          <th>Số lượng</th>
          <th>Giá</th>
          <th>Thành tiền</th>
          <th>Thao tác</th>
        </tr>
        </thead>
        <tbody>
        <tr th:each="item : ${order.orderItems}">
          <td>
            <!-- Hiển thị hình ảnh sản phẩm -->
            <img th:if="${!item.product.images.isEmpty()}"
                 th:src="@{${item.product.images[0].imageUrl}}"
                 class="img-thumbnail"
                 alt="Product Image"
                 width="100" height="100"/>
            <img th:if="${item.product.images.isEmpty()}"
                 th:src="@{/images/placeholder.jpg}"
                 class="img-thumbnail"
                 alt="No Image"
                 width="100" height="100"/>
          </td>
          <td th:text="${item.product.name}">Tên sản phẩm</td>
          <td>
            <div th:if="${item.measurement != null}">
              <strong class="text-primary">custom</strong>
              <div class="measurement-details">
                <div th:if="${item.measurement.bustSize != null}" class="measurement-item">
                  <i class="fas fa-ruler"></i> Ngực: [[${item.measurement.bustSize}]]cm
                </div>
                <div th:if="${item.measurement.waistSize != null}" class="measurement-item">
                  <i class="fas fa-ruler"></i> Eo: [[${item.measurement.waistSize}]]cm
                </div>
                <div th:if="${item.measurement.hipsSize != null}" class="measurement-item">
                  <i class="fas fa-ruler"></i> Hông: [[${item.measurement.hipsSize}]]cm
                </div>
                <div th:if="${item.measurement.buttSize != null}" class="measurement-item">
                  <i class="fas fa-ruler"></i> Mông: [[${item.measurement.buttSize}]]cm
                </div>
                <div th:if="${item.measurement.armLength != null}" class="measurement-item">
                  <i class="fas fa-ruler"></i> Dài tay: [[${item.measurement.armLength}]]cm
                </div>
                <div th:if="${item.measurement.shoulderWidth != null}" class="measurement-item">
                  <i class="fas fa-ruler"></i> Rộng vai: [[${item.measurement.shoulderWidth}]]cm
                </div>
                <div th:if="${item.measurement.neckSize != null}" class="measurement-item">
                  <i class="fas fa-ruler"></i> Vòng cổ: [[${item.measurement.neckSize}]]cm
                </div>
                <div th:if="${item.measurement.skirtLength != null}" class="measurement-item">
                  <i class="fas fa-ruler"></i> Dài váy: [[${item.measurement.skirtLength}]]cm
                </div>
                <div th:if="${item.measurement.hipDrop != null}" class="measurement-item">
                  <i class="fas fa-ruler"></i> Eo-Hông: [[${item.measurement.hipDrop}]]cm
                </div>
                <div th:if="${item.measurement.waistDrop != null}" class="measurement-item">
                  <i class="fas fa-ruler"></i> Vai-Eo: [[${item.measurement.waistDrop}]]cm
                </div>
                <div th:if="${item.measurement.note != null}" class="measurement-note">
                  <i class="fas fa-sticky-note"></i> <em th:text="${item.measurement.note}">Ghi chú</em>
                </div>
              </div>
            </div>
            <div th:if="${item.measurement == null}">
              <span th:if="${item.size != null}" class="size-badge">Size: [[${item.size}]]</span>
              <span th:if="${item.size == null}" class="text-muted">Chưa chọn size</span>
            </div>
          </td>
          <td>
            <ul th:if="${item.decorations != null and not #lists.isEmpty(item.decorations)}" class="list-unstyled mb-0">
              <li th:each="d : ${item.decorations}"
                  th:text="${d.name + ' (+' + #numbers.formatDecimal(d.extraPrice, 0, 'COMMA', 0, 'POINT') + '₫)'}"></li>
            </ul>
            <span th:if="${item.decorations == null or #lists.isEmpty(item.decorations)}">-</span>
          </td>
          <td th:text="${item.quantity}">1</td>
          <td th:text="${#numbers.formatDecimal(item.product.price, 0, 'COMMA', 0, 'POINT')} + '₫'">0</td>
          <td th:text="${#numbers.formatDecimal(item.totalPrice, 0, 'COMMA', 0, 'POINT')} + '₫'">0</td>
          <td>
            <div class="d-flex gap-2">
              <span th:if="${reviewedProducts[item.product.id] != null}">
      <button type="button" class="btn btn-success view-review-btn"
              th:data-product-id="${item.product.id}"
              title="Xem lại đánh giá">
  <i class="bi bi-eye"></i> Xem lại đánh giá
</button>
    </span>
              <span th:if="${reviewedProducts[item.product.id] == null}">
      <button type="button" class="btn btn-primary review-product-btn"
              th:data-product-id="${item.product.id}"
              th:data-user-id="${order.user.id}"
              title="Đánh giá">
        <i class="bi bi-star"></i> Đánh giá
      </button>
    </span>
            </div>
          </td>
        </tr>
        </tbody>
      </table>

      <div class="back-link">
        <a th:href="@{'/order/list?userId=' + ${order.user.id}}">← Quay lại danh sách đơn hàng</a>
      </div>
    </div>
  </div>
</div>

<!-- Footer -->
<div th:replace="fragments/footer :: footer"></div>

<div class="modal fade" id="reviewProductModal" tabindex="-1" aria-labelledby="reviewProductModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <form id="reviewProductForm" method="post" th:action="@{/reviews/add}">
        <div class="modal-header">
          <h5 class="modal-title" id="reviewProductModalLabel">Đánh giá sản phẩm</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Đóng"></button>
        </div>
        <div class="modal-body">
          <input type="hidden" id="reviewProductId" name="productId"/>
          <input type="hidden" id="reviewOrderId" name="orderId" th:value="${order.id}"/>
            <input type="hidden" id="reviewUserId" name="userId"/>
          <div class="mb-3">
            <label for="reviewRating" class="form-label">Đánh giá</label>
            <select class="form-select" id="reviewRating" name="rating" required>
              <option value="">-- Chọn số sao --</option>
              <option value="5">5 sao - Xuất sắc</option>
              <option value="4">4 sao - Tốt</option>
              <option value="3">3 sao - Bình thường</option>
              <option value="2">2 sao - Kém</option>
              <option value="1">1 sao - Rất tệ</option>
            </select>
          </div>
          <div class="mb-3">
            <label for="reviewContent" class="form-label">Nội dung nhận xét</label>
            <textarea id="reviewContent" name="content" class="form-control" rows="4" required placeholder="Hãy chia sẻ cảm nhận của bạn về sản phẩm..."></textarea>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
          <button type="submit" class="btn btn-primary">Gửi đánh giá</button>
        </div>
      </form>
    </div>
  </div>
</div>

<div class="modal fade" id="viewReviewModal" tabindex="-1" aria-labelledby="viewReviewModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="viewReviewModalLabel">Xem lại đánh giá</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Đóng"></button>
      </div>
      <div class="modal-body">
        <div>
          <strong>Số sao:</strong> <span id="reviewViewRating"></span> / 5
        </div>
        <div class="mt-2">
          <strong>Nội dung:</strong>
          <div id="reviewViewContent" class="mt-1"></div>
        </div>
        <div class="mt-2 text-muted" style="font-size:13px;">
          <span id="reviewViewDate"></span>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
      </div>
    </div>
  </div>
</div>

<!-- Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js"></script>

<!-- reviewedProducts must be defined first -->
<script th:inline="javascript">
  /*<![CDATA[*/
  var reviewedProducts = /*[[${reviewedProducts}]]*/ {};
  console.log('reviewedProducts from Thymeleaf:', reviewedProducts);
  console.log('reviewedProducts type:', typeof reviewedProducts);
  console.log('reviewedProducts keys:', Object.keys(reviewedProducts));
  /*]]>*/
</script>

<!-- JavaScript functions -->
<script>
  // Đợi DOM tải xong
  document.addEventListener('DOMContentLoaded', function() {
    
    // Định nghĩa hàm viewReview
    window.viewReview = function(productId) {
      console.log('=== viewReview DEBUG ===');
      console.log('viewReview called with productId:', productId);
      console.log('productId type:', typeof productId);
      console.log('reviewedProducts:', reviewedProducts);
      console.log('reviewedProducts keys:', Object.keys(reviewedProducts));
      
      // Thử cả string và number
      var review = reviewedProducts[productId] || reviewedProducts[String(productId)] || reviewedProducts[parseInt(productId)];
      
      console.log('Found review:', review);
      
      if (review) {
        console.log('Review object:', review);
        console.log('Review.rating:', review.rating);
        console.log('Review.comment:', review.comment);
        console.log('Review.content:', review.content);
        console.log('Review.createdAt:', review.createdAt);
        
        document.getElementById('reviewViewRating').textContent = review.rating;
        document.getElementById('reviewViewContent').textContent = review.comment || review.content; // Thử cả 2
        document.getElementById('reviewViewDate').textContent = review.createdAt
          ? ("Ngày đánh giá: " + review.createdAt)
          : "";
        
        var modal = new bootstrap.Modal(document.getElementById('viewReviewModal'));
        modal.show();
      } else {
        console.log('No review found for product:', productId);
        console.log('Available product IDs:', Object.keys(reviewedProducts));
        alert('Không tìm thấy đánh giá cho sản phẩm này.');
      }
    };

    // Định nghĩa hàm reviewProduct
    window.reviewProduct = function(productId, userId) {
      console.log('reviewProduct called with productId:', productId, 'userId:', userId);
      
      document.getElementById('reviewProductId').value = productId;
      document.getElementById('reviewUserId').value = userId;
      document.getElementById('reviewContent').value = '';
      document.getElementById('reviewRating').value = '';
      
      var reviewModal = new bootstrap.Modal(document.getElementById('reviewProductModal'));
      reviewModal.show();
    };

    // Thêm event listeners cho các nút
    document.addEventListener('click', function(e) {
      // Event listener cho nút "Xem lại đánh giá"
      if (e.target.closest('.view-review-btn')) {
        e.preventDefault();
        const productId = e.target.closest('.view-review-btn').getAttribute('data-product-id');
        viewReview(productId);
      }
      
      // Event listener cho nút "Đánh giá"
      if (e.target.closest('.review-product-btn')) {
        e.preventDefault();
        const productId = e.target.closest('.review-product-btn').getAttribute('data-product-id');
        const userId = e.target.closest('.review-product-btn').getAttribute('data-user-id');
        reviewProduct(productId, userId);
      }
    });
    
  });
</script>

</body>
</html>
